<!DOCTYPE html>
<html lang="en">
<head>
  <title>Eva Voice Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0ff">
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #0ff;
      text-align: center;
      padding: 50px;
      min-height: 100vh;
    }
    h1 {
      font-size: 2.5em;
      margin-bottom: 0.5em;
    }
    #status, #question, #answer {
      font-size: 1.2em;
      margin: 1em 0;
    }
    p { margin: 1em auto; max-width: 600px; }
    .note { color: #888; font-size: 0.95em; }
    button {
      margin-top: 2em; padding: 0.8em 2em; font-size: 1em;
      background: #0ff; color: #111; border: none; border-radius: 8px; cursor: pointer;
    }
    button:active { background: #09c; }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ Say "Eva" to Wake</h1>
  <p class="note">Tap anywhere or click the button below to start listening.<br>
  Ask Eva anything after saying "Eva".</p>
  <button id="start">Start Listening</button>
  <p id="status">Waiting...</p>
  <p id="question"></p>
  <p id="answer"></p>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
const statusEl = document.getElementById("status");
const questionEl = document.getElementById("question");
const answerEl = document.getElementById("answer");
const startBtn = document.getElementById("start");

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let wakeMode = true;
let answering = false;

function resetToWake() {
  wakeMode = true;
  answering = false;
  statusEl.textContent = "Say 'Eva' to wake again...";
  questionEl.textContent = "";
  answerEl.textContent = "";
  if (recognition) {
    recognition.stop();
    setTimeout(() => recognition.start(), 400); // Restart recognition after a brief pause
  }
}

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;

  recognition.onstart = () => {
    statusEl.textContent = "ðŸŽ¤ Listening... Say 'Eva'";
  };

  recognition.onresult = (event) => {
    if (answering) return; // Prevent double answering

    const transcript = event.results[event.results.length-1][0].transcript.toLowerCase().trim();
    // Wake mode: listen for "eva"
    if (wakeMode && transcript.includes("eva")) {
      wakeMode = false;
      statusEl.textContent = "âœ… Activated! Ask me something...";
      questionEl.textContent = "";
      answerEl.textContent = "";
      return;
    }
    // Question mode: listen for question
    if (!wakeMode && event.results[event.results.length-1].isFinal) {
      answering = true;
      const q = transcript;
      questionEl.textContent = "â“ " + q;
      askWiki(q);
    }
  };

  recognition.onerror = (e) => {
    statusEl.textContent = "Error: " + e.error;
    setTimeout(resetToWake, 2000);
  };

  recognition.onend = () => {
    // Only restart if not answering (prevents double speaking)
    if (!answering) {
      recognition.start();
    }
  };
} else {
  statusEl.textContent = "Voice recognition not supported in this browser.";
  startBtn.disabled = true;
}

function startListening() {
  if (recognition) {
    recognition.start();
    statusEl.textContent = "ðŸŽ¤ Listening started... Say 'Eva'";
    startBtn.style.display = "none";
  }
}
startBtn.addEventListener("click", startListening);
document.body.addEventListener("click", function(e){
  if (e.target !== startBtn) startListening();
}, { once: true });

async function askWiki(text) {
  answerEl.textContent = "Searching Wikipedia...";
  try {
    const res = await fetch("https://en.wikipedia.org/api/rest_v1/page/summary/" + encodeURIComponent(text));
    const data = await res.json();
    if (data.extract) {
      answerEl.textContent = data.extract;
      speak(data.extract, resetToWake);
    } else {
      answerEl.textContent = "No info found.";
      setTimeout(resetToWake, 2000);
    }
  } catch (e) {
    answerEl.textContent = "Fetch error.";
    setTimeout(resetToWake, 2000);
  }
}

// Call reset after speaking
function speak(text, callback) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.onend = () => {
    if (typeof callback === "function") callback();
  };
  speechSynthesis.speak(u);
}
</script>
</body>

</html>

